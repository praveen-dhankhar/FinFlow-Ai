name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  # Default Node environment (override per-job if you want)
  NODE_ENV: test

jobs:
  checkout:
    name: Checkout code
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.rev.outputs.sha }}
    steps:
      - uses: actions/checkout@v3
      - id: rev
        run: echo "::set-output name=sha::$(git rev-parse HEAD)"

  backend:
    name: Build & Test Spring Boot
    needs: checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # ↑ If you prefer to stay on Java 17 instead of 21, change <release> in your pom.xml to 17
      - name: Set up Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run Maven build & tests
        # inject your DB creds from GitHub Secrets
        env:
          DB_URL:      ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: mvn clean verify -B

  frontend:
    name: Lint, Test & Build React/Node
    needs: checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # ---- FIX #2: ensure your .env.example actually exists under ./frontend,
      # or generate .env from secrets instead of copying .env.example.

      # Option A: copy a committed example
      - name: Copy in .env for frontend
        working-directory: ./frontend
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "No .env.example found, generating from secrets..."
            cat <<EOF > .env
            REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
            EOF
          fi

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint & Type-check
        working-directory: ./frontend
        run: npm run lint && npm run type-check

      - name: Run unit tests
        working-directory: ./frontend
        run: npm test -- --ci --reporters=default

      - name: Build production bundle
        working-directory: ./frontend
        # ensure REACT_APP_* keys come from Secrets → Settings → Secrets
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        run: npm run build

  security-scan:
    name: Snyk security scan
    needs: checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # install & authenticate Snyk CLI
      - uses: snyk/actions/setup@v1
        with:
          version: 'latest'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Authenticate Snyk CLI
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Run snyk test
        run: snyk test --all-projects

  e2e:
    name: E2E Tests (Cypress)
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18.x

      - name: Install all deps
        run: npm ci

      - name: Start services
        run: |
          cd backend && mvn spring-boot:run & 
          cd frontend && npm start &
          npx wait-on http://localhost:8080 && npx wait-on http://localhost:3000

      - name: Run Cypress
        run: npx cypress run

  performance:
    name: Lighthouse Performance
    needs: frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: treosh/lighthouse-ci-action@v8
        with:
          configPath: ./lighthouserc.json

  deploy:
    name: Deploy to Vercel
    if: github.ref == 'refs/heads/main'
    needs: [performance, security-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id:  ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
