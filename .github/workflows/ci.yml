name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  # global defaults for all jobs
  NODE_ENV: test

jobs:
  checkout:
    name: Checkout Code
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.rev.outputs.sha }}
    steps:
      - uses: actions/checkout@v3
      - id: rev
        run: echo "::set-output name=sha::$(git rev-parse HEAD)"

  backend:
    name: Build & Test Spring Boot
    needs: checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'
      - name: Inject DB creds from Secrets
        # these env vars become available to Spring Boot at runtime
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          mvn clean verify -B

  frontend:
    name: Build & Test React/Node
    needs: checkout
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Copy in .env for Node (if you have a local .env.example)
        # OPTIONAL: if you committed a .env.example with placeholders
        run: |
          cp .env.example .env

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint & Type-check
        working-directory: ./frontend
        run: npm run lint && npm run type-check

      - name: Run Unit Tests
        working-directory: ./frontend
        run: npm test -- --ci --reporters=default

      - name: Build Production Bundle
        working-directory: ./frontend
        # ensure your REACT_APP_ vars are set in Secrets → Settings → Environments
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        run: npm run build

  e2e:
    name: E2E Tests
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: { node-version: 18.x }

      - name: Install all deps
        run: npm ci

      - name: Start Backend & Frontend
        run: |
          # adapt these: start servers in the background
          cd backend && mvn spring-boot:run & 
          cd frontend && npm start &
          # wait for them to come up
          npx wait-on http://localhost:3000 && npx wait-on http://localhost:8080

      - name: Run Cypress
        run: npx cypress run

  performance:
    name: Lighthouse Performance
    needs: frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: treosh/lighthouse-ci-action@v8
        with:
          configPath: ./lighthouserc.json

  security-scan:
    name: Snyk Security Scan
    needs: checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: snyk/actions/setup@v1
      - name: Run Snyk test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test

  deploy:
    name: Deploy to Vercel
    if: github.ref == 'refs/heads/main'
    needs: [performance, security-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
